import { NextSeo } from "next-seo";
import { isMultiLanguage } from "../../lib/isMultiLanguage.js";
import {
  getCurrentLocaleStore,
  globalDrupalStateStores,
} from "../../lib/drupalStateContext";

import { withGrid, ArticleGridItem } from "../../components/grid.js";
import PageHeader from "../../components/page-header.js";
import Layout from "../../components/layout";

export default function SSRArticlesListTemplate({
  articles,
  hrefLang,
  multiLanguage,
}) {
  const ArticleGrid = withGrid(ArticleGridItem);
  return (
    <Layout>
      <NextSeo
        title="Decoupled Next Drupal Demo"
        description="Generated by create next app."
        languageAlternates={hrefLang || false}
      />
      <PageHeader title="Articles" />
      <section>
        <ArticleGrid
          data={articles}
          contentType="articles"
          multiLanguage={multiLanguage}
        />
      </section>
    </Layout>
  );
}

export async function getServerSideProps(context) {
  try {
    const origin = process.env.NEXT_PUBLIC_FRONTEND_URL;
    const { locales } = context;
    // if there is more than one language in context.locales,
    // assume multilanguage is enabled.
    const multiLanguage = isMultiLanguage(locales);
    const hrefLang = locales.map((locale) => {
      return {
        hrefLang: locale,
        href: origin + "/" + locale,
      };
    });

    const store = getCurrentLocaleStore(
      context.locale,
      globalDrupalStateStores
    );

    store.params.clear();
    store.params.addInclude(["field_media_image.field_media_image"]);

    const articles = await store.getObject({
      objectName: "node--article",
      res: context.res,
    });
    store.params.clear();

    if (!articles) {
      throw new Error(
        "No articles returned. Make sure the objectName and store.params are valid!"
      );
    }

    return {
      props: {
        articles,
        hrefLang,
        multiLanguage,
      },
    };
  } catch (error) {
    console.error("Unable to fetch articles: ", error);
    return {
      props: {},
    };
  }
}
